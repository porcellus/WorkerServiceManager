{"version":3,"file":"bundle.umd.js","sources":["../src/deferredPromise.ts","../src/portHandler.ts","../src/messageTransformers/defaultMessageTransformer.ts","../src/serviceMap.ts","../src/multiRemoteService.ts","../src/remoteService.ts","../src/workerServiceManager.ts"],"sourcesContent":["export class DeferredPromise<T> {\r\n  public promise: Promise<T>;\r\n  public resolve: (value?: PromiseLike<T> | T) => void;\r\n  public reject: (reason?: any) => void;\r\n\r\n  constructor() {\r\n    this.promise = new Promise((res, rej) => {\r\n      this.resolve = res;\r\n      this.reject = rej;\r\n    });\r\n  }\r\n}\r\n","import { DeferredPromise } from \"./deferredPromise\";\r\nimport {MessageTransformer, Transferable} from \"./messageTransformers/messageTransformer\";\r\n\r\nexport interface IMessagePort {\r\n  onmessage: (event: MessageEvent) => void | Promise<void>;\r\n  terminate: () => void;\r\n\r\n  postMessage(data: any[], transfers?: any[]);\r\n  postMessage(data: any[], port: string, transfers?: any[]);\r\n}\r\n\r\nenum PortCommands {\r\n  call,\r\n  fire,\r\n  resolve,\r\n  reject,\r\n}\r\n\r\nexport class PortHandler {\r\n  private callHandler: (service, method, args) => Promise<any>;\r\n  private deferreds: Map<number, DeferredPromise<any>>;\r\n  private nextPid: number;\r\n  private port: IMessagePort;\r\n\r\n  constructor(private portPromise: Promise<IMessagePort> | IMessagePort, private messageTransformer: MessageTransformer, private targetOrigin?: string) {\r\n    this.nextPid = 0;\r\n    this.deferreds = new Map<number, DeferredPromise<any>>();\r\n    this.callHandler = null;\r\n    if (!(this.portPromise instanceof Promise)) {\r\n      this.port = this.portPromise;\r\n      this.port.onmessage = this.handleMessage.bind(this);\r\n    } else this.portPromise.then((port) => {\r\n          this.port = port;\r\n          this.port.onmessage = this.handleMessage.bind(this);\r\n      });\r\n  }\r\n\r\n  public async terminate() {\r\n      const port = this.port ? this.port : await this.portPromise;\r\n\r\n      port.onmessage = undefined;\r\n      port.terminate();\r\n\r\n      this.portPromise = undefined;\r\n      this.port = undefined;\r\n  }\r\n\r\n  public async call(service, method, args): Promise<any> {\r\n    if (!this.port && !this.portPromise)\r\n      throw new Error(\"PortTerminated\");\r\n    const deferred = new DeferredPromise<any>();\r\n    const pid = this.nextPid++;\r\n    this.deferreds.set(pid, deferred);\r\n    const msg = this.messageTransformer.transformMessage(args);\r\n    await this.postMessage([PortCommands.call, pid, service, method, msg[0]], msg[1], this.targetOrigin);\r\n    return deferred.promise;\r\n  }\r\n\r\n  public setCallHandler(handler) {\r\n    if (this.callHandler !== null) throw new Error(\"Call handler already set\");\r\n    this.callHandler = handler;\r\n  }\r\n\r\n  public fire(service, method, args): Promise<void> {\r\n    if (!this.port && !this.portPromise)\r\n      throw new Error(\"PortTerminated\");\r\n\r\n    const msg = this.messageTransformer.transformMessage(args);\r\n    return this.postMessage([PortCommands.fire, service, method, msg[0]], msg[1], this.targetOrigin);\r\n  }\r\n\r\n  private async postMessage(msg: any, transferables: Transferable[], origin?: string) {\r\n    const port = this.port ? this.port : await this.portPromise;\r\n    if (this.targetOrigin)\r\n      port.postMessage(msg, this.targetOrigin, transferables);\r\n    else\r\n      port.postMessage(msg, transferables);\r\n  }\r\n\r\n  private async handleMessage(ev) {\r\n    switch (ev.data[0]) { // cmd\r\n      case PortCommands.fire:\r\n        try {\r\n          // We intentionally ignore the result (and even the errors) of the call. This is rarely a good idea,\r\n          // but it is sometimes useful.\r\n          //noinspection JSIgnoredPromiseFromCall\r\n          this.callHandler(ev.data[2], ev.data[3], ev.data[4]);\r\n        } catch (ex) {\r\n          // We ignore errors during calls because we have no way to handle them.\r\n          // TODO: add an settable error handler/logger\r\n          // console.error(ex);\r\n        }\r\n        break;\r\n      case PortCommands.call:\r\n        try {\r\n          const res = await this.callHandler(\r\n            ev.data[2],\r\n            ev.data[3],\r\n            ev.data[4],\r\n          );\r\n          const msg = this.messageTransformer.transformMessage(res);\r\n          await this.postMessage([PortCommands.resolve, ev.data[1], msg[0]], msg[1], this.targetOrigin);\r\n        } catch (ex) {\r\n          const msg = this.messageTransformer.transformMessage(ex);\r\n          await this.postMessage([PortCommands.reject, ev.data[1], msg[0]], msg[1], this.targetOrigin);\r\n        }\r\n        break;\r\n      case PortCommands.resolve:\r\n        this.deferreds.get(ev.data[1]).resolve(ev.data[2]);\r\n        this.deferreds.delete(ev.data[1]);\r\n        break;\r\n      case PortCommands.reject:\r\n        this.deferreds.get(ev.data[1]).reject(ev.data[2]);\r\n        this.deferreds.delete(ev.data[1]);\r\n        break;\r\n    }\r\n  }\r\n}\r\n","import {MessageTransformer, Transferable} from \"./messageTransformer\";\r\n\r\nfunction transformError(err) {\r\n    return {\r\n        name: err.name,\r\n        message: err.message,\r\n        stack: err.stack,\r\n    }\r\n}\r\n\r\nexport class DefaultMessageTransformer implements MessageTransformer {\r\n  private transform(message: any, visited: Map<any, boolean>): [any, Transferable[], boolean] {\r\n      if (message && typeof message === 'object') {\r\n          visited.set(message, false);\r\n          switch (Object.prototype.toString.call(message)) {\r\n              case '[object ArrayBuffer]':\r\n              case '[object Uint8Array]':\r\n              case '[object Int8Array]':\r\n              case '[object Uint16Array]':\r\n              case '[object Int16Array]':\r\n              case '[object Uint32Array]':\r\n              case '[object Int32Array]':\r\n              case '[object Float32Array]':\r\n              case '[object Float64Array]':\r\n                  if (message.buffer.byteLength === message.byteLength) {\r\n                      visited.set(message, false);\r\n                      return [message, [message.buffer], false];\r\n                  } else {\r\n                      const copy = new message.constructor(message);\r\n                      visited.set(message, true);\r\n                      return [copy, [copy.buffer], true];\r\n                  }\r\n              case '[object Array]':\r\n                  const res = message.map(e => this.transform(e, visited));\r\n                  const copied = res.reduce((a, c) => a || c, false);\r\n                  visited.set(message, copied);\r\n                  return [copied ? res.map(a => a[0]) : message, res.reduce((a, c) => a.concat(c[1]), []), copied];\r\n              case '[object Promise]':\r\n              case '[object XMLHttpRequest]':\r\n              case '[object Event]':\r\n                  throw new Error('CommunicationErrorNonMessageableValue');\r\n              case '[object DOMError]':\r\n              case '[object DOMException]':\r\n                  visited.set(message, true);\r\n                  return [transformError(message), [], true];\r\n              default:\r\n                  if (message instanceof Error) {\r\n                      visited.set(message, true);\r\n                      return [transformError(message), [], true];\r\n                  }\r\n                  const resObj = {};\r\n                  let transferrables = [];\r\n                  let copiedObj = false;\r\n                  for (const key of Object.keys(message)) {\r\n                      if (!key.startsWith('_')) {\r\n                          const cRes = this.transform(message[key], visited);\r\n                          transferrables = transferrables.concat(cRes[2]);\r\n                          if (cRes[3]) {\r\n                              copiedObj = true;\r\n                              resObj[key] = copiedObj;\r\n                          } else {\r\n                              resObj[key] = message[key];\r\n                          }\r\n                      }\r\n                  }\r\n                  visited.set(message, copiedObj);\r\n                  return [copiedObj ? resObj : message, transferrables, copiedObj];\r\n          }\r\n      }\r\n      return [message, [], false];\r\n  }\r\n\r\n  transformMessage(message: any): [any, Transferable[]] {\r\n    return this.transform(message, new Map<any, boolean>()).slice(0,2) as [any, Transferable[]];\r\n  }\r\n}","import { PortHandler } from \"./portHandler\";\r\nimport {MessageTransformer} from \"./messageTransformers/messageTransformer\";\r\nimport {DefaultMessageTransformer} from \"./messageTransformers/defaultMessageTransformer\";\r\n\r\nexport class ServiceMap {\r\n  public services: Map<string, any>;\r\n  public ports: PortHandler[];\r\n\r\n  constructor(private messageTransformer: MessageTransformer = new DefaultMessageTransformer()) {\r\n    this.services = new Map<string, any>();\r\n    this.ports = [];\r\n  }\r\n\r\n  public addPort(port: any) {\r\n    const handler = new PortHandler(port, this.messageTransformer);\r\n    handler.setCallHandler(this.handleCall.bind(this));\r\n    this.ports.push(handler);\r\n    return handler;\r\n  }\r\n\r\n  public terminatePort(handler: PortHandler): void {\r\n      this.ports.splice(this.ports.indexOf(handler), 1);\r\n      handler.terminate();\r\n  }\r\n\r\n  public addServiceObject(name, obj: any) {\r\n    return this.services.set(name, obj);\r\n  }\r\n\r\n  public async handleCall(service: string, method: string, args: any[]) {\r\n    const serviceObj = this.services.get(service);\r\n    if (serviceObj !== undefined) return await serviceObj[method](...args);\r\n\r\n    // We don't know about this service at all...\r\n    throw new Error(\"Service not found\");\r\n  }\r\n}\r\n","import {DeferredPromise} from \"./deferredPromise\";\r\nimport {IMessagePort, PortHandler} from \"./portHandler\";\r\nimport {RemoteService} from \"./remoteService\";\r\nimport {ServiceMap} from \"./serviceMap\";\r\nimport {MessageTransformer} from \"./messageTransformers/messageTransformer\";\r\nimport {DefaultMessageTransformer} from \"./messageTransformers/defaultMessageTransformer\";\r\n\r\nexport class MultiRemoteService<T extends RemoteService> {\r\n    private busyPorts: T[];\r\n    private freePorts: PortHandler[];\r\n\r\n    private queue: Array<DeferredPromise<PortHandler>>;\r\n\r\n    constructor(private serviceMap: ServiceMap,\r\n                private portFactory: () => Promise<IMessagePort>, private proxyType: new (ph: PortHandler) => T,\r\n                private maxPorts: number, private minPorts: number = 0,\r\n                private messageTransformer: MessageTransformer = new DefaultMessageTransformer(),\r\n                ) {\r\n        this.busyPorts = [];\r\n        this.freePorts = [];\r\n        this.queue = [];\r\n    }\r\n\r\n    public spinUp() {\r\n        while (this.freePorts.length < this.minPorts)\r\n            this.releasePort(this.getNewPort());\r\n    }\r\n\r\n    public async getRemote(): Promise<T> {\r\n      let portHandler: PortHandler;\r\n      if (this.busyPorts.length >= this.maxPorts) {\r\n          const prom = new DeferredPromise<PortHandler>();\r\n          this.queue.push(prom);\r\n          portHandler = await prom.promise;\r\n      } else if (this.freePorts.length > 0)\r\n          portHandler = this.freePorts.shift();\r\n      else\r\n          portHandler = this.getNewPort();\r\n\r\n      const remote = new this.proxyType(portHandler);\r\n      this.busyPorts.push(remote);\r\n\r\n      return remote;\r\n    }\r\n\r\n    public releaseRemote(remote: T): void {\r\n        const portHandler = remote.detach();\r\n\r\n        this.busyPorts.splice(this.busyPorts.indexOf(remote), 1);\r\n\r\n        this.releasePort(portHandler);\r\n    }\r\n\r\n    private releasePort(portHandler: PortHandler): void {\r\n        if (this.queue.length > 0) {\r\n            const deferred = this.queue.shift();\r\n            deferred.resolve(portHandler);\r\n        } else if (this.freePorts.length < this.minPorts)\r\n            this.freePorts.push(portHandler);\r\n        else // noinspection JSIgnoredPromiseFromCall\r\n            portHandler.terminate();\r\n    }\r\n\r\n    private getNewPort() {\r\n        const ph = new PortHandler(this.portFactory(), this.messageTransformer);\r\n        ph.setCallHandler(this.serviceMap.handleCall.bind(this.serviceMap));\r\n        return ph;\r\n    }\r\n}\r\n","import { PortHandler } from \"./portHandler\";\r\n\r\nexport class RemoteService {\r\n  public name: string;\r\n\r\n  constructor(private port: PortHandler) {}\r\n\r\n  public async call(method, args = []) {\r\n    if (this.port === undefined)\r\n      throw new Error(\"RemoteDetached\");\r\n\r\n    return await this.port.call(this.name, method, args);\r\n  }\r\n\r\n  public detach(): PortHandler {\r\n      const port = this.port;\r\n      this.port = undefined;\r\n      return port;\r\n  }\r\n}\r\n","import { PortHandler } from \"./portHandler\";\r\nimport { RemoteService } from \"./remoteService\";\r\nimport { ServiceMap } from \"./serviceMap\";\r\nimport {MessageTransformer} from \"./messageTransformers/messageTransformer\";\r\nimport {DefaultMessageTransformer} from \"./messageTransformers/defaultMessageTransformer\";\r\n\r\nexport class WorkerServiceManager extends ServiceMap {\r\n  constructor(localServiceMap, remoteServiceMap, messageTransformer: MessageTransformer = new DefaultMessageTransformer()) {\r\n    super(messageTransformer);\r\n\r\n    localServiceMap.forEach((obj, name) => this.addServiceObject(name, obj));\r\n\r\n    remoteServiceMap.forEach((serviceProxyTypes, port) => {\r\n      const portHandler = this.addPort(port);\r\n\r\n      serviceProxyTypes.forEach((serviceProxyInfo) => {\r\n        const proxy = new serviceProxyInfo[1](portHandler);\r\n        proxy.name = serviceProxyInfo[0];\r\n        this.addServiceObject(serviceProxyInfo[0], proxy);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport { MultiRemoteService } from \"./multiRemoteService\";\r\nexport { RemoteService } from \"./remoteService\";\r\nexport { PortHandler } from \"./portHandler\";\r\n"],"names":[],"mappings":"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"}